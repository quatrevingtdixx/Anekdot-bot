name: ü§ñ Publish Anekdot

on:
  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–∫–Ω–æ–ø–∫–∞)
  workflow_dispatch:
    inputs:
      note:
        description: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–ø—É—Å–∫—É'
        required: false
        default: '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫'
  
  # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï:
  schedule:
    # –ë–£–î–ù–ò–ï –î–ù–ò (–ø–Ω-–ø—Ç): 8:00, 13:00, 20:00 –ú–°–ö
    - cron: '0 5 * * 1-5'    # 8:00 –ú–°–ö (5:00 UTC)
    - cron: '0 10 * * 1-5'   # 13:00 –ú–°–ö (10:00 UTC)
    - cron: '0 17 * * 1-5'   # 20:00 –ú–°–ö (17:00 UTC)
    
    # –í–´–•–û–î–ù–´–ï –î–ù–ò (—Å–±-–≤—Å): 10:00, 14:00, 21:00 –ú–°–ö
    - cron: '0 7 * * 6,0'    # 10:00 –ú–°–ö (7:00 UTC)
    - cron: '0 11 * * 6,0'   # 14:00 –ú–°–ö (11:00 UTC)
    - cron: '0 18 * * 6,0'   # 21:00 –ú–°–ö (18:00 UTC)

jobs:
  publish-anekdot:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        # –í–∞–∂–Ω–æ: –∑–∞–±–∏—Ä–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã
        fetch-depth: 0
    
    # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot
    
    # 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
    - name: ü§ñ Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        MY_CHAT_ID: ${{ secrets.MY_CHAT_ID }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é Telegram –±–æ—Ç–∞..."
        echo "üìÖ –î–∞—Ç–∞: $(date '+%d.%m.%Y %H:%M –ú–°–ö')"
        python bot.py
    
    # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –±–æ—Ç –æ–±–Ω–æ–≤–∏–ª —Ñ–∞–π–ª—ã
    - name: üíæ Commit and push changes
      run: |
        # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö..."
        git status
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
        if [[ -n $(git status --porcelain anekdots.txt last_id.txt) ]]; then
          echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—é..."
          
          # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
          echo "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ anekdots.txt:"
          git diff anekdots.txt || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          
          echo "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ last_id.txt:"
          git diff last_id.txt || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          
          # –î–æ–±–∞–≤–∏—Ç—å –∏ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å
          git add anekdots.txt last_id.txt
          git commit -m "ü§ñ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∞–Ω–µ–∫–¥–æ—Ç [–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏]"
          
          # –ó–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
        else
          echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
        fi
    
    # 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    - name: üìä Log result
      run: |
        echo "üéâ Workflow –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üïê –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date '+%H:%M:%S')"
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π last_id
        if [ -f "last_id.txt" ]; then
          echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π ID: $(cat last_id.txt)"
        fi
