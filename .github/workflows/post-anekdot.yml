name: ü§ñ Publish Anekdot

on:
  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–∫–Ω–æ–ø–∫–∞)
  workflow_dispatch:
    inputs:
      note:
        description: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–ø—É—Å–∫—É'
        required: false
        default: '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫'
  
  # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï:
  schedule:
    # –ë–£–î–ù–ò–ï –î–ù–ò (–ø–Ω-–ø—Ç): 8:00, 13:00, 20:00 –ú–°–ö
    - cron: '0 5 * * 1-5'    # 8:00 –ú–°–ö (5:00 UTC)
    - cron: '0 10 * * 1-5'   # 13:00 –ú–°–ö (10:00 UTC)
    - cron: '0 17 * * 1-5'   # 20:00 –ú–°–ö (17:00 UTC)
    
    # –í–´–•–û–î–ù–´–ï –î–ù–ò (—Å–±-–≤—Å): 10:00, 14:00, 21:00 –ú–°–ö
    - cron: '0 7 * * 6,0'    # 10:00 –ú–°–ö (7:00 UTC)
    - cron: '0 11 * * 6,0'   # 14:00 –ú–°–ö (11:00 UTC)
    - cron: '0 18 * * 6,0'   # 21:00 –ú–°–ö (18:00 UTC)

jobs:
  publish-anekdot:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot
    
    # 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
    - name: ü§ñ Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        MY_CHAT_ID: ${{ secrets.MY_CHAT_ID }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é Telegram –±–æ—Ç–∞..."
        echo "üìÖ –î–∞—Ç–∞: $(date '+%d.%m.%Y %H:%M –ú–°–ö')"
        python bot.py
    
    # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –±–æ—Ç –æ–±–Ω–æ–≤–∏–ª —Ñ–∞–π–ª—ã (–£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
    - name: üíæ Save changes locally
      if: always()
      run: |
        echo "üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ..."
        
        # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ª–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if [ -f "anekdots.txt" ] && [ -f "last_id.txt" ]; then
          echo "üìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ last_id.txt:"
          cat last_id.txt
          
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ anekdots.txt:"
          grep -c "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω: –î–∞" anekdots.txt || echo "0"
          
          echo "‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –±–æ—Ç–æ–º"
        else
          echo "‚ö†Ô∏è –§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        fi
    
    # 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    - name: üìä Log result
      if: always()
      run: |
        echo "üéâ Workflow –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üïê –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date '+%H:%M:%S')"
