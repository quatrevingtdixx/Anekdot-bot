import pandas as pd
from telegram import Bot, ParseMode
from datetime import datetime
import os
import sys

# –ü–æ–ª—É—á–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è GitHub Actions
BOT_TOKEN = os.environ['BOT_TOKEN']
CHANNEL_ID = os.environ['CHANNEL_ID']
MY_CHAT_ID = os.environ.get('MY_CHAT_ID', '')  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

def send_telegram_notification(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –º–æ–π –ª–∏—á–Ω—ã–π Telegram"""
    if not MY_CHAT_ID:
        return False
    
    try:
        bot = Bot(token=BOT_TOKEN)
        bot.send_message(
            chat_id=MY_CHAT_ID,
            text=message,
            parse_mode=ParseMode.HTML
        )
        return True
    except Exception as e:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram: {e}")
        return False

def post_anekdot():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
    1. –ò—â–µ—Ç –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç
    2. –ü—É–±–ª–∏–∫—É–µ—Ç –µ–≥–æ –≤ –∫–∞–Ω–∞–ª
    3. –û–±–Ω–æ–≤–ª—è–µ—Ç CSV —Ñ–∞–π–ª
    4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    """
    try:
        # 1. –ß–∏—Ç–∞–µ–º CSV —Ñ–∞–π–ª —Å –∞–Ω–µ–∫–¥–æ—Ç–∞–º–∏
        print("üìñ –ß–∏—Ç–∞—é —Ñ–∞–π–ª —Å –∞–Ω–µ–∫–¥–æ—Ç–∞–º–∏...")
        df = pd.read_csv('anekdots.csv')
        
        # 2. –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        total_jokes = len(df)
        published_jokes = df['–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?'].fillna('').eq('–î–∞').sum()
        remaining_jokes = total_jokes - published_jokes
        
        print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Å–µ–≥–æ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤: {total_jokes}, "
              f"–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {published_jokes}, "
              f"–û—Å—Ç–∞–ª–æ—Å—å: {remaining_jokes}")
        
        # 3. –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        if 1 <= remaining_jokes <= 3:
            warning_message = (
                f"‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ! –ó–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –∞–Ω–µ–∫–¥–æ—Ç—ã</b>\n\n"
                f"–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ <b>{remaining_jokes}</b> –∞–Ω–µ–∫–¥–æ—Ç–æ–≤.\n"
                f"–°–æ–≤–µ—Ç—É—é –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –≤ —Ñ–∞–π–ª anekdots.csv"
            )
            send_telegram_notification(warning_message)
            print(f"‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –æ—Å—Ç–∞–ª–æ—Å—å {remaining_jokes} –∞–Ω–µ–∫–¥–æ—Ç–æ–≤")
        
        # 4. –ò—â–µ–º –ø–µ—Ä–≤—ã–π –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç
        for index, row in df.iterrows():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –∞–Ω–µ–∫–¥–æ—Ç
            is_published = str(row.get('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?', '')).strip() == '–î–∞'
            
            if not is_published:
                joke_text = str(row['–¢–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞']).strip()
                
                if not joke_text or joke_text == 'nan':
                    print(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é –ø—É—Å—Ç–æ–π –∞–Ω–µ–∫–¥–æ—Ç –≤ —Å—Ç—Ä–æ–∫–µ {index + 1}")
                    continue
                
                # 5. –ü—É–±–ª–∏–∫—É–µ–º –∞–Ω–µ–∫–¥–æ—Ç –≤ Telegram-–∫–∞–Ω–∞–ª
                print(f"üì§ –ü—É–±–ª–∏–∫—É—é –∞–Ω–µ–∫–¥–æ—Ç #{index + 1}...")
                bot = Bot(token=BOT_TOKEN)
                bot.send_message(chat_id=CHANNEL_ID, text=joke_text)
                
                # 6. –û–±–Ω–æ–≤–ª—è–µ–º CSV —Ñ–∞–π–ª
                current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                df.at[index, '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?'] = '–î–∞'
                df.at[index, '–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'] = current_time
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                df.to_csv('anekdots.csv', index=False)
                
                print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∞–Ω–µ–∫–¥–æ—Ç #{index + 1}")
                print(f"   –¢–µ–∫—Å—Ç: {joke_text[:60]}...")
                print(f"   –í—Ä–µ–º—è: {current_time}")
                print(f"   –û—Å—Ç–∞–ª–æ—Å—å –∞–Ω–µ–∫–¥–æ—Ç–æ–≤: {remaining_jokes - 1}")
                
                return True  # –£—Å–ø–µ—à–Ω–æ –Ω–∞—à–ª–∏ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –∞–Ω–µ–∫–¥–æ—Ç
        
        # 7. –ï—Å–ª–∏ –≤—Å–µ –∞–Ω–µ–∫–¥–æ—Ç—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã
        print("üì≠ –í—Å–µ –∞–Ω–µ–∫–¥–æ—Ç—ã —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã!")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        emergency_message = (
            "üö® <b>–°–†–û–ß–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï</b>\n\n"
            "üí• <b>–í—Å–µ –∞–Ω–µ–∫–¥–æ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</b>\n\n"
            f"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤: {total_jokes}\n"
            f"‚Ä¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {published_jokes}\n"
            f"‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: 0\n\n"
            "üîß <i>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</i>\n"
            "1. –û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª anekdots.csv –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏\n"
            "2. –î–æ–±–∞–≤—å –Ω–æ–≤—ã–µ –∞–Ω–µ–∫–¥–æ—Ç—ã –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞\n"
            "3. –ò–ª–∏ —É–¥–∞–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è '–î–∞' –∏–∑ —Å—Ç–æ–ª–±—Ü–∞ '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?'\n"
            "4. –ó–∞–ø—É—Å—Ç–∏ workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
        )
        
        if send_telegram_notification(emergency_message):
            print("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∞–Ω–µ–∫–¥–æ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å")
        else:
            print("‚ÑπÔ∏è MY_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
        
        # 8. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏
        # (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –±–æ—Ç –Ω–∞—á–∞–ª –ø–æ—Å—Ç–∏—Ç—å –ø–æ –∫—Ä—É–≥—É)
        """
        print("üîÑ –°–±—Ä–∞—Å—ã–≤–∞—é –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏...")
        df['–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?'] = ''
        df['–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'] = ''
        df.to_csv('anekdots.csv', index=False)
        print("‚úÖ –í—Å–µ –æ—Ç–º–µ—Ç–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞—é —Å –Ω–∞—á–∞–ª–∞")
        return True
        """
        
        return False  # –ê–Ω–µ–∫–¥–æ—Ç–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å
        
    except FileNotFoundError:
        error_message = (
            "‚ùå <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</b>\n\n"
            "–§–∞–π–ª <code>anekdots.csv</code> –Ω–µ –Ω–∞–π–¥–µ–Ω!\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏."
        )
        print("‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª anekdots.csv –Ω–µ –Ω–∞–π–¥–µ–Ω")
        send_telegram_notification(error_message)
        return False
        
    except KeyError as e:
        error_message = (
            "‚ùå <b>–û–®–ò–ë–ö–ê –í –§–û–†–ú–ê–¢–ï –§–ê–ô–õ–ê</b>\n\n"
            f"–í CSV —Ñ–∞–π–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω—É–∂–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü: {e}\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ –µ—Å—Ç—å —Å—Ç–æ–ª–±—Ü—ã:\n"
            "‚Ä¢ –¢–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞\n"
            "‚Ä¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω?\n"
            "‚Ä¢ –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏"
        )
        print(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ CSV —Ñ–∞–π–ª–µ: {e}")
        send_telegram_notification(error_message)
        return False
        
    except Exception as e:
        error_message = (
            "‚ùå <b>–ù–ï–ò–ó–í–ï–°–¢–ù–ê–Ø –û–®–ò–ë–ö–ê</b>\n\n"
            f"–¢–∏–ø –æ—à–∏–±–∫–∏: {type(e).__name__}\n"
            f"–°–æ–æ–±—â–µ–Ω–∏–µ: {str(e)[:200]}"
        )
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {type(e).__name__}: {e}")
        send_telegram_notification(error_message)
        return False

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è GitHub Actions
    """
    print("\n" + "="*50)
    print("ü§ñ –ó–ê–ü–£–°–ö –ë–û–¢–ê –î–õ–Ø –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –ê–ù–ï–ö–î–û–¢–û–í")
    print("="*50)
    
    success = post_anekdot()
    
    print("\n" + "="*50)
    if success:
        print("‚úÖ –í–´–ü–û–õ–ù–ï–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û")
        sys.exit(0)  # –ö–æ–¥ 0 = —É—Å–ø–µ—Ö
    else:
        print("‚ùå –í–´–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –° –û–®–ò–ë–ö–û–ô")
        sys.exit(1)  # –ö–æ–¥ 1 = –æ—à–∏–±–∫–∞

if __name__ == "__main__":
    main()
